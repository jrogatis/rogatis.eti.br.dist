{"version":3,"sources":["api/user/user.controller.js"],"names":["index","create","showInfo","show","destroy","changePassword","changeSettings","me","authCallback","validationError","res","statusCode","err","status","json","handleError","send","handleEntityNotFound","entity","end","req","find","exec","then","users","catch","newUser","body","provider","role","save","user","token","sign","_id","secrets","session","expiresIn","userId","params","id","findById","next","console","log","profile","findByIdAndRemove","oldPass","String","oldPassword","newPass","newPassword","authenticate","password","userNewSettings","fullName","city","state","error","findOne","redirect"],"mappings":"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","file":"user.controller.js","sourcesContent":["'use strict';\n\nimport User from './user.model';\nimport config from '../../config/environment';\nimport jwt from 'jsonwebtoken';\n\nfunction validationError(res, statusCode) {\n  statusCode = statusCode || 422;\n  return function(err) {\n    return res.status(statusCode).json(err);\n  };\n}\n\nfunction handleError(res, statusCode) {\n  statusCode = statusCode || 500;\n  return function(err) {\n    return res.status(statusCode).send(err);\n  };\n}\n\n\nfunction handleEntityNotFound(res) {\n  return function(entity) {\n    if(!entity) {\n      res.status(404).end();\n      return null;\n    }\n    return entity;\n  };\n}\n/**\n * Get list of users\n * restriction: 'admin'\n */\nexport function index(req, res) {\n  return User.find({}, '-salt -password').exec()\n    .then(users => {\n      res.status(200).json(users);\n    })\n    .catch(handleError(res));\n}\n\n/**\n * Creates a new user\n */\nexport function create(req, res) {\n  var newUser = new User(req.body);\n  newUser.provider = 'local';\n  newUser.role = 'user';\n  newUser.save()\n    .then(function(user) {\n      var token = jwt.sign({ _id: user._id }, config.secrets.session, {\n        expiresIn: 60 * 60 * 5\n      });\n      res.json({ token });\n    })\n    .catch(validationError(res));\n}\n\n/**\n * Get a single user Info\n */\nexport function showInfo(req, res) {\n  var userId = req.params.id;\n\n  return User.findById(userId).exec()\n    .then(handleEntityNotFound(res))\n    .then(user => {\n      res.json(user);\n    });\n}\n\n/**\n * Get a single user\n */\nexport function show(req, res, next) {\n  console.log('no show');\n  var userId = req.params.id;\n\n  return User.findById(userId).exec()\n    .then(user => {\n      if(!user) {\n        return res.status(404).end();\n      }\n      res.json(user.profile);\n    })\n    .catch(err => next(err));\n}\n\n/**\n * Deletes a user\n * restriction: 'admin'\n */\nexport function destroy(req, res) {\n  return User.findByIdAndRemove(req.params.id).exec()\n    .then(function() {\n      res.status(204).end();\n    })\n    .catch(handleError(res));\n}\n\n/**\n * Change a users password\n */\nexport function changePassword(req, res) {\n  var userId = req.user._id;\n  var oldPass = String(req.body.oldPassword);\n  var newPass = String(req.body.newPassword);\n\n  return User.findById(userId).exec()\n    .then(user => {\n      if(user.authenticate(oldPass)) {\n        user.password = newPass;\n        return user.save()\n          .then(() => {\n            res.status(204).end();\n          })\n          .catch(validationError(res));\n      } else {\n        return res.status(403).end();\n      }\n    });\n}\n\nexport function changeSettings(req, res) {\n  var userId = req.user._id;\n  var userNewSettings = req.body;\n  return User.findById(userId).exec()\n    .then(user => {\n      user.fullName = userNewSettings.newUser.fullName;\n      user.city = userNewSettings.newUser.city;\n      user.state = userNewSettings.newUser.state;\n      return user.save()\n        .then(() => {\n          res.status(204).end();\n        })\n        .catch(error => console.log(error));\n    });\n}\n\n/**\n * Get my info\n */\nexport function me(req, res, next) {\n  var userId = req.user._id;\n\n  return User.findOne({ _id: userId }, '-salt -password').exec()\n    .then(user => { // don't ever give out the password or salt\n      if(!user) {\n        return res.status(401).end();\n      }\n      res.json(user);\n    })\n    .catch(err => next(err));\n}\n\n/**\n * Authentication callback\n */\nexport function authCallback(req, res) {\n  res.redirect('/');\n}\n"]}